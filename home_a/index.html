<!DOCTYPE html>
<html>

<head>
    <title>Simple D3.js Zoom to Node Example</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <audio id="myAudio" src="slomo.wav"></audio>
    <script>
        var width = window.innerWidth;
        var height = window.innerHeight;
        var r = 200;
        // var audio = new Audio('slomo.wav');
        var zoom = d3.zoom().on("zoom", zoomed);

        var svg = d3.select("body")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g");

        svg.call(zoom.transform, d3.zoomIdentity.translate(width / 2, height / 2).scale(0.1));

        let fo = svg.append("foreignObject")
            .attr("width", r * 2)
            .attr("height", r * 2)
            .attr("x", width / 2 - r*2)
            .attr("y", height / 2 - r*2)
            .attr("class", "fo")
            .style("opacity", 0);

        var circle = svg.append("circle")
            .attr("cx", width / 2 - r)
            .attr("cy", height / 2 - r)
            .attr("r", r)
            .style("fill", "#154671")
            .on("click", onClick);


        // Add a div to the foreignObject
        let div = fo.append("xhtml:div")
            .attr("class", "div");

        // Add the project name to the div
        div.append("p")
            .attr("class", "project")
            .html('<iframe src="earth" width="100%" height="100%"></iframe>');

        function zoomed() {
            svg.attr("transform", d3.event.transform);
        }

        function onClick() {
            playAudio();
            var scaleX = width / 2 - r*2;
            var scaleY = height / 2 - r*2;
            var scale = 2;

            svg.transition()
                .delay(50)
                .duration(9450)
                .ease(d3.easePolyOut)
                .call(zoom.transform, d3.zoomIdentity.translate(scaleX - scale * scaleX, scaleY - scale * scaleY).scale(scale))
                .on("end", () => {
                    circle.transition()
                        .duration(500)
                        .ease(d3.easePolyOut)
                        .style("opacity", 0)
                        .on("end", () => {
                            fo.transition().duration(500).ease(d3.easePolyOut).style("opacity", 1);
                            circle.remove();
                        });
                });
        }

        function playAudio() {
            var audio = document.getElementById("myAudio");
            audio.volume = 1.0;
            audio.play();

            // start volume fade out 5 seconds before the end.
            setTimeout(function () {
                var fadeAudio = setInterval(function () {
                    if ((audio.volume -= 0.1) <= 0.1) { // fades volume by 0.1 every 100 ms
                        clearInterval(fadeAudio);
                    }
                }, 100);
            }, (audio.duration - 1) * 1000);
        }

    </script>
</body>

</html>